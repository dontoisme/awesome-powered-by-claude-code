name: Auto Opt-Out

on:
  issues:
    types: [opened, labeled]

jobs:
  process-opt-out:
    if: contains(github.event.issue.labels.*.name, 'opt-out')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract repo URL from issue
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title;

            // Try to extract GitHub URL from body or title
            const urlPattern = /https:\/\/github\.com\/[\w-]+\/[\w.-]+/gi;
            const bodyMatches = issueBody ? issueBody.match(urlPattern) : [];
            const titleMatches = issueTitle ? issueTitle.match(urlPattern) : [];

            const allMatches = [...(bodyMatches || []), ...(titleMatches || [])];

            if (allMatches.length === 0) {
              core.setFailed('No GitHub repository URL found in issue');
              return;
            }

            // Clean up URL (remove trailing slashes, etc.)
            const repoUrl = allMatches[0].replace(/\/+$/, '');
            console.log(`Found repo URL: ${repoUrl}`);
            core.setOutput('repo_url', repoUrl);

            // Extract just the repo path for matching in markdown
            const repoPath = repoUrl.replace('https://github.com/', '');
            core.setOutput('repo_path', repoPath);

      - name: Remove entry from README
        id: remove
        run: |
          REPO_URL="${{ steps.extract.outputs.repo_url }}"
          REPO_PATH="${{ steps.extract.outputs.repo_path }}"

          echo "Looking for: $REPO_URL"

          # Check if the repo exists in README
          if grep -q "$REPO_URL" README.md; then
            echo "Found entry, removing..."

            # Remove the line containing the repo URL
            # This handles the table row format: | [name](url) | description | author |
            sed -i "\|$REPO_URL|d" README.md

            echo "removed=true" >> $GITHUB_OUTPUT
            echo "Entry removed successfully"
          else
            echo "removed=false" >> $GITHUB_OUTPUT
            echo "Entry not found in README.md"
          fi

      - name: Commit changes
        if: steps.remove.outputs.removed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Remove ${{ steps.extract.outputs.repo_path }} (opt-out request #${{ github.event.issue.number }})"
          git push

      - name: Comment and close issue (removed)
        if: steps.remove.outputs.removed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Opt-out processed successfully**\n\nYour repository has been removed from the list.\n\nCommit: ${context.sha}\n\nThank you for letting us know your preference. If you change your mind in the future, feel free to submit your project again.\n\n---\n*This action was performed automatically.*`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Comment and close issue (not found)
        if: steps.remove.outputs.removed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ℹ️ **Repository not found in list**\n\nThe repository \`${{ steps.extract.outputs.repo_url }}\` was not found in our current list.\n\nThis could mean:\n- It was already removed\n- The URL format doesn't match our records\n- It was never added\n\nIf you believe this is an error, please comment with the exact URL as it appears in our README.\n\n---\n*This action was performed automatically.*`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: ['opt-out', 'not-found']
            });
